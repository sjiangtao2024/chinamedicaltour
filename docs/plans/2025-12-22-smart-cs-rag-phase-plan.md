# 智能客服 RAG 迁移 Phase 开发计划

## 目标
平滑将现有 `smart-cs` 从“大系统提示词”迁移到“RAG + Vectorize”，同时新增 D1 聊天记录保存（10–30 天），保持线上可回滚。

## 里程碑概览
- Phase 0：基线与设计确认
- Phase 1：内容更新链路（ops + R2 + 向量构建）
- Phase 2：RAG 影子验证（不影响回复）
- Phase 3：RAG 正式启用（可回滚）
- Phase 4：聊天记录存储（D1 + 清理）
- Phase 5：Workflows 预留升级（可选）

---

## Phase 0：基线与设计确认
**目标**：明确模型、分块、Top‑K 与降级策略，不修改线上逻辑。  
**产出**：配置表、参数表、回滚策略。

**任务清单**
- 确认 embedding 模型（如 `@cf/baai/bge-small-en-v1.5`）。
- 设定分块规则（500–800 tokens/块，按标题优先切分）。
- 设定 Top‑K（建议 3–5）与 fallback 逻辑。
- 明确 RAG 失败降级为旧系统提示词。

**验收**
- 参数文档明确、共识达成。

---

## Phase 1：内容更新链路（ops + R2 + Vectorize）
**目标**：非技术人员可更新知识库；索引可自动重建。  
**不影响线上**。

**任务清单**
- 部署 `ops` Worker（`ops.chinamedicaltour.org`）。
- 实现登录页 + 编辑页（admin token）。
- 上传 Markdown 到 R2（`knowledge/knowledge.md`）。
- R2 事件触发向量重建：
  - 拉取 Markdown
  - 清洗/切分
  - embedding
  - upsert Vectorize
- 输出重建日志与状态记录。

**验收**
- ops 登录可用。
- R2 上传成功，触发重建。
- Vectorize 可检索到新内容。

---

## Phase 2：RAG 影子验证（不改回复）
**目标**：在不影响用户回复的情况下，验证检索质量与性能。

**任务清单**
- `smart-cs` 增加检索逻辑，但不注入回答。
- 记录检索日志（Top‑K、耗时、命中片段）。
- 抽样人工评估检索相关性。

**验收**
- 检索稳定、延迟可控。
- 命中片段质量达到预期。

---

## Phase 3：RAG 正式启用（可回滚）
**目标**：正式使用 RAG 注入知识。

**任务清单**
- 用“规则提示词 + 检索片段”替换大系统提示词。
- 保留旧提示词作为兜底（开关控制）。
- 监控回答质量与延迟。

**回滚策略**
- 一键切回旧系统提示词。

**验收**
- 用户侧回答正常，质量不下降。
- 延迟不超过既定阈值。

---

## Phase 4：聊天记录存储（D1 + 清理）
**目标**：保存聊天记录 10–30 天，并定期清理。

**任务清单**
- 建 D1 表（如 `chat_logs`）。
- `smart-cs` 写入聊天记录（请求、响应、时间、request_id）。
- Scheduled Worker 每日清理超过保留期的数据。

**验收**
- 日志写入正常。
- 清理任务可执行。

---

## Phase 5：Workflows 预留升级（可选）
**目标**：当内容规模或更新频率上升时，引入 Workflows 承担重建流程。

**任务清单**
- 将 R2 触发重建迁移至 Workflows。
- 增加重试、状态跟踪与告警。

**验收**
- 重建流程可观测、可追踪、可重试。

---

## 风险与缓解
- Workers AI Neurons 配额：embedding 用量需监控，超额可转外部 embedding。
- 检索质量不足：调优分块与 Top‑K。
- 向量重建失败：保留旧索引并提供手动重建入口。

## 关键开关
- `RAG_ENABLED`：控制是否注入检索片段。
- `FALLBACK_PROMPT_ENABLED`：控制是否启用旧系统提示词。

## 验收总标准
- 内容更新无需代码发布。
- 回答质量稳定，延迟可控。
- D1 日志满足 10–30 天保留。
