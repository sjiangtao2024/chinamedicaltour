# PayPal 证据驱动支付流程指引（防拒付版）

目标：用“证据链 + 支付方式分流”对抗拒付与冻结风险，适配中国商家跨境收款现实。

适用范围：China Medical Tour 会员费、定金、尾款收款流程。

## 0. 现状盘点（代码与页面）

### 已实现（现有系统）
- PayPal 下单与捕获接口：`/api/paypal/create`、`/api/paypal/capture`、`/api/paypal/webhook`（Workers）。  
- 订单创建与状态更新（orders 表 + webhook 状态回写）。  
- 前端 checkout 仅支持 PayPal（sandbox），支持套餐与定金。  

### 缺口与风险
- **PayPal 仍可收全额套餐**（违反“小额走 PayPal”原则）。  
- **缺少 T&C 强制勾选与证据留存**（条款版本、IP、UA 未记录）。  
- **缺少 Invoice 与邮件送达日志**（无争议证据链）。  
- **缺少下载/签收日志**（数字服务证据不足）。  
- **定金缺少护照 KYC 与电子合同签署**。  
- **PayPal 仍为 sandbox、无环境切换**。  

## 1. 核心三原则（必须执行）

1) **PayPal 只收小额**  
   - 仅收会员费与定金（Deposit）。  
   - 尾款只接受微信/支付宝/线下刷卡。  

2) **数字交付必须有签收证据**  
   - 登录/下载/合同签署落日志。  
   - 邮件仅提供登录链接，不直发内容。  

3) **条款强制勾选且可审计**  
   - 支付前强制勾选 T&C + No-Refund。  
   - 勾选记录保存（时间、IP、UA、版本号）。  

## 2. 支付方式策略（与本项目规则一致）

### 定金（Deposit）
- 可接受：PayPal、微信、支付宝。  
- 金额建议：$200 - $500。  

### 尾款（Balance）
- 只接受：微信、支付宝、线下信用卡刷卡。  
- 原因：PayPal 对中国收款稳定性与争议处理不友好，且拒付风险高。  

## 3. 国际客户使用支付宝/微信的限制与坑（基于内部最佳实践文档）

### 共同限制
- **必须实名/护照认证后才可提升额度**。  
- **存在单笔与累计限额**，超额需分期/分笔。  
- **P2P 转账、红包等功能受限**（对商户收款不影响，但会影响客户习惯）。  
- **无法直接提现到境外账户**（客户侧限制）。  

### 支付宝（国际用户）
- 未认证：单笔约 $500；已认证：单笔约 $5,000，年累计 $50,000。  
- 需护照 + 人脸认证，超过 $500 交易必须完成认证。  
- 支持 Visa/Mastercard 等国际卡绑定。  
- 风险点：客户未完成认证时，支付可能失败或额度不足。  

### 微信支付（国际用户）
- 单笔约 6,000 RMB；月累计 50,000 RMB；年累计 60,000 RMB。  
- 实名认证支持护照、港澳台等证件。  
- 支持多种国际卡（Visa/Mastercard/AmEx/JCB 等）。  
- 风险点：没有中国手机号时部分功能受限；限额更紧，需要拆单。  

### 运营建议
- 高额支付默认拆分为多笔。  
- 提前向客户说明认证与限额要求。  
- 提供“支付引导页”与客服协助完成绑定。  

## 4. 会员购买流程（Membership）

### Step 1: Checkout 与条款确认
- 收集 Email 作为唯一 ID。  
- 强制勾选：  
  - “数字服务立即交付”  
  - “下载后放弃冷静期退款权利”  

### Step 2: 证据自动生成
- 自动生成 Invoice（PDF）：  
  - Status: PAID  
  - Service: 1 Year Membership  
  - Non-refundable Digital Good  
- 发送确认邮件（含 Invoice PDF）。  
- 记录 Delivered / Opened 日志。  

### Step 3: 权益激活 + 下载日志
- 邮件仅提供登录链接。  
- 用户登录后下载 PDF。  
- 记录 User ID + IP + 时间 + 下载动作。  

## 5. 定金支付流程（Deposit）

### Step 1: 预订与 KYC
- 要求上传护照首页。  
- 校验支付账户姓名与护照姓名一致。  

### Step 2: 支付定金
- PayPal Item Name 标注：  
  - `Non-refundable Medical Booking Deposit for [Date]`  
- 微信/支付宝二维码收款需配置为“服务类”商品名。  

### Step 3: 数字合同签署（关键）
- 支付后进入合同页面。  
- 电子签名确认定金不可退、取消期限。  
- 合同签署完成后才发送确认邮件与 Invoice。  

## 6. 尾款支付流程（Balance）

### 只接受
1) 线下刷卡（Card Present）  
2) 支付宝（绑定外卡）  
3) 微信支付（绑定外卡）  

### 运营建议
- 到店前发送支付指引与限额说明。  
- 超额拆分或分日支付。  
- 支付完成后再开始医疗服务。  

## 7. 技术执行清单（系统落地）

### PayPal 商家后台（必须开启）
- AVS Check：拒绝地址验证失败交易  
- CVV Check：拒绝安全码错误交易  
- Risk Block：拒绝高风险 IP/代理  

### 系统功能（必须实现）
- Invoice 自动生成（唯一 Invoice ID）。  
- T&C 勾选记录：版本、时间、IP、UA。  
- 用户行为日志：登录、下载、签署。  
- 邮件送达/打开日志回执。  

### 文案模板（Invoice/邮件）
Invoice 末尾追加：  
```
Ref: Cancellation & Refund Policy. This transaction covers digital goods/booking services rendered immediately. By processing this payment, the cardholder acknowledges the service is satisfactorily received.
```

## 8. 证据链清单（争议申诉必备）

- 订单信息（订单号、金额、币种、支付时间）  
- 条款勾选记录（时间、IP、UA、条款版本）  
- Invoice PDF  
- 邮件送达/打开日志  
- 下载日志或合同签署记录  
- 护照文件（仅限定金流程）  

## 9. 最佳实践防拒付支付流程（建议版）

1) 用户选择产品 -> 明确支付分流：  
   - 会员费/定金：PayPal 或 微信/支付宝。  
   - 尾款：微信/支付宝/线下刷卡。  
2) 支付前强制条款勾选并记录。  
3) 定金支付后进入合同签署流程。  
4) 生成 Invoice + 邮件发送并保留送达日志。  
5) 数字服务交付必须经登录下载或签收。  
6) 尾款必须在现场完成并留存刷卡小票或支付凭证。  

---

本指引用于支付流程 review 与落地执行，后续改动需同步更新本文件。
